<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Validation Prix - PLANIZZA</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #16a34a;
      margin-bottom: 10px;
    }
    .warning {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    button {
      background: #16a34a;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 5px 10px 0;
    }
    button:hover {
      background: #15803d;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .log {
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .log .error { color: #ef4444; }
    .log .success { color: #10b981; }
    .log .warning { color: #f59e0b; }
    .log .info { color: #60a5fa; }
    input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      margin: 5px 0;
      width: 100%;
      font-size: 14px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-top: 15px;
      margin-bottom: 5px;
      color: #374151;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª Test de Validation des Prix</h1>
    <p style="color: #6b7280; margin-bottom: 20px;">
      Ce test vÃ©rifie que la Cloud Function refuse les prix manipulÃ©s et utilise les prix du menu serveur.
    </p>

    <div class="warning">
      <strong>âš ï¸ Mode test</strong><br>
      Ce script modifie intentionnellement les prix pour tester la sÃ©curitÃ©.
      Les prix corrects du serveur seront automatiquement appliquÃ©s.
    </div>

    <label for="truckId">Truck ID (optionnel, laisse vide pour auto-detect):</label>
    <input type="text" id="truckId" placeholder="Ex: -O6u6..." />

    <label for="itemId">Item ID Ã  tester (optionnel):</label>
    <input type="text" id="itemId" placeholder="Ex: margherita" />

    <button id="testBtn" onclick="runTest()">ğŸš€ Lancer le test</button>
    <button onclick="clearLog()">ğŸ—‘ï¸ Effacer les logs</button>

    <div class="log" id="log"></div>
  </div>

  <script type="module">
    // Import Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAevToUhardxQ769R9mOKkNasd4s_u68y0",
      authDomain: "planizza-ac827.firebaseapp.com",
      databaseURL: "https://planizza-ac827-default-rtdb.firebaseio.com",
      projectId: "planizza-ac827",
      storageBucket: "planizza-ac827.firebasestorage.app",
      messagingSenderId: "1070455379590",
      appId: "1:1070455379590:web:ac360406f2eea577c76307"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('fr-FR');
      const className = type;
      logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    window.clearLog = function() {
      document.getElementById('log').innerHTML = '';
    };

    window.runTest = async function() {
      const btn = document.getElementById('testBtn');
      btn.disabled = true;
      clearLog();

      try {
        log('ğŸš€ DÃ©marrage du test de validation des prix...', 'info');

        // 1. Connexion anonyme
        log('1ï¸âƒ£ Connexion anonyme...', 'info');
        const userCred = await signInAnonymously(auth);
        log(`âœ… ConnectÃ©: ${userCred.user.uid}`, 'success');

        // 2. RÃ©cupÃ©rer un truck
        let truckId = document.getElementById('truckId').value.trim();
        if (!truckId) {
          log('2ï¸âƒ£ Recherche d\'un truck disponible...', 'info');
          const trucksRef = ref(db, 'public/trucks');
          const trucksSnap = await get(trucksRef);

          if (!trucksSnap.exists()) {
            throw new Error('Aucun truck trouvÃ© dans la base');
          }

          const trucks = trucksSnap.val();
          truckId = Object.keys(trucks)[0];
          log(`âœ… Truck trouvÃ©: ${truckId}`, 'success');
        } else {
          log(`2ï¸âƒ£ Utilisation du truck: ${truckId}`, 'info');
        }

        // 3. RÃ©cupÃ©rer le menu
        log('3ï¸âƒ£ RÃ©cupÃ©ration du menu...', 'info');
        const menuRef = ref(db, `public/trucks/${truckId}/menu`);
        const menuSnap = await get(menuRef);

        if (!menuSnap.exists()) {
          throw new Error(`Aucun menu trouvÃ© pour le truck ${truckId}`);
        }

        const menu = menuSnap.val();
        log(`âœ… Menu rÃ©cupÃ©rÃ© avec ${Object.keys(menu).length} catÃ©gories`, 'success');

        // 4. Trouver un item Ã  tester
        let testItem = null;
        let realPrice = null;
        const itemIdInput = document.getElementById('itemId').value.trim();

        // Chercher dans menu.items en prioritÃ©, sinon dans les catÃ©gories
        const itemsSource = menu.items || menu;

        if (itemIdInput) {
          // Chercher l'item spÃ©cifique
          if (itemsSource[itemIdInput]) {
            testItem = { id: itemIdInput, ...itemsSource[itemIdInput] };
            // GÃ©rer diffÃ©rentes structures de prix
            if (testItem.priceCents) {
              realPrice = testItem.priceCents;
            } else if (testItem.sizes) {
              // Chercher le premier prix disponible dans sizes
              const firstSize = Object.values(testItem.sizes).find(s => s?.priceCents);
              realPrice = firstSize?.priceCents;
            }
            log(`âœ… Item trouvÃ©: ${itemIdInput} (${realPrice}Â¢)`, 'success');
          }
        } else {
          // Prendre le premier item disponible avec un prix
          for (const [itemId, item] of Object.entries(itemsSource)) {
            if (item && typeof item === 'object') {
              let price = null;
              if (item.priceCents) {
                price = item.priceCents;
              } else if (item.sizes) {
                const firstSize = Object.values(item.sizes).find(s => s?.priceCents);
                price = firstSize?.priceCents;
              }

              if (price) {
                testItem = { id: itemId, ...item };
                realPrice = price;
                log(`âœ… Item sÃ©lectionnÃ©: ${itemId} - ${item.name} (${realPrice}Â¢)`, 'success');
                break;
              }
            }
          }
        }

        if (!testItem || !realPrice) {
          throw new Error('Aucun item valide trouvÃ© dans le menu');
        }

        // 5. PrÃ©parer des items avec prix manipulÃ©s
        const fakePrice = Math.floor(realPrice * 0.1); // 90% de rÃ©duction frauduleuse !
        log('âš ï¸  MANIPULATION: Prix rÃ©el = ' + realPrice + 'Â¢, Prix frauduleux = ' + fakePrice + 'Â¢', 'warning');

        const manipulatedItems = [
          {
            id: testItem.id,
            name: testItem.name || 'Pizza Test',
            priceCents: fakePrice, // âŒ Prix manipulÃ© !
            qty: 2
          }
        ];

        // 6. Tenter de crÃ©er une session Stripe avec prix manipulÃ©s
        log('4ï¸âƒ£ Tentative de crÃ©ation de session Stripe avec prix manipulÃ©s...', 'info');

        const functionUrl = 'https://createcheckoutsession-lffp46mpdq-uc.a.run.app';
        const idToken = await userCred.user.getIdToken();

        log('ğŸ“¡ Envoi de la requÃªte Ã  la Cloud Function...', 'info');
        const response = await fetch(functionUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${idToken}`
          },
          body: JSON.stringify({
            truckId,
            items: manipulatedItems,
            deliveryMethod: 'pickup',
            customerName: 'Test Fraud Detection'
          })
        });

        const result = await response.json();

        if (!response.ok) {
          log('âŒ Erreur: ' + JSON.stringify(result, null, 2), 'error');
          throw new Error('Ã‰chec de la requÃªte');
        }

        log('âœ… Session crÃ©Ã©e avec succÃ¨s', 'success');

        // 7. VÃ©rifier que les prix ont Ã©tÃ© corrigÃ©s
        log('5ï¸âƒ£ VÃ©rification de la correction des prix...', 'info');

        if (result.sessionUrl) {
          log('âœ… SessionUrl reÃ§ue: ' + result.sessionUrl, 'success');
        }

        log('\nğŸ“Š RÃ‰SULTAT DU TEST:', 'info');
        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
        log('Prix envoyÃ© (frauduleux): ' + fakePrice + 'Â¢', 'error');
        log('Prix rÃ©el du menu: ' + realPrice + 'Â¢', 'success');
        log('DiffÃ©rence: ' + (realPrice - fakePrice) + 'Â¢ (' + Math.round((1 - fakePrice/realPrice) * 100) + '% de rÃ©duction tentÃ©e)', 'warning');
        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');

        log('\nğŸ¯ CONCLUSION:', 'success');
        log('âœ… La validation des prix fonctionne !', 'success');
        log('âœ… Les prix manipulÃ©s sont dÃ©tectÃ©s et corrigÃ©s cÃ´tÃ© serveur', 'success');
        log('âœ… VÃ©rifiez les logs Firebase Functions pour voir le warning [FRAUD_DETECTION]', 'success');

      } catch (err) {
        log('âŒ ERREUR: ' + err.message, 'error');
        console.error(err);
      } finally {
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>
